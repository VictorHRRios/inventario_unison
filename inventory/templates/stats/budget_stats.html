{% extends "base.html" %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}

{% block content %}
    <div class="content-section">
        <h2 class="report-header">REPORTES <span class="highlight">PRESUPUESTO</span></h2>

        <!-- Agregar un formulario para seleccionar fechas -->
        <form id="date-range-form">
            {% csrf_token %}
            {{ form.as_p }}
        </form>

        <!-- Agregar un contenedor para el gráfico -->
        <div>
            <canvas id="myChart" width="400" height="200"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tu código de Chart.js -->
    <script>
        // Obtener los elementos del formulario y del gráfico
        const dateRangeForm = document.getElementById('date-range-form');
        const myChartCanvas = document.getElementById('myChart');
        const myChartContext = myChartCanvas.getContext('2d');

        // Función para generar el gráfico con fechas dinámicas
        function generateChart() {
            // Obtener las fechas seleccionadas del formulario
            const startDate = document.getElementById('id_start_date').value;
            const endDate = document.getElementById('id_end_date').value;

            // Simular la obtención de datos dinámicos para las fechas
            const dynamicDate = getDatesBetween(startDate, endDate);

            // Grafico
            new Chart(myChartContext, {
                type: "line",
                data: {
                    labels: dynamicDate,
                    datasets: [
                        {
                            label: 'Dinero ingresado en materiales',
                            backgroundColor: "rgba(0,0,255,1.0)",
                            borderColor: "rgba(0,0,255,0.5)",
                            data: dynamicData.entrys
                        },
                        {
                            label: 'Dinero gastado en materiales',
                            backgroundColor: "rgba(255,0,0,1.0)",
                            borderColor: "rgba(255,0,0,0.5)",
                            data: dynamicData.outlays
                        }
                    ]
                },
                options: {
                    // Puedes agregar opciones adicionales aquí
                }
            });
        }

        // Función para simular datos dinámicos (reemplázala con la lógica de tu aplicación real)
        function getDynamicData(startDate, endDate) {
            // Aquí deberías realizar una solicitud al servidor para obtener datos según las fechas seleccionadas
            // En este ejemplo, simplemente genero datos aleatorios para ilustrar el concepto

            const entrys = [];
            const outlays = [];

            // Lógica para generar fechas y valores aleatorios (reemplaza con tu lógica real)
            for (let i = 0; i < 10; i++) {
                dates.push(`Fecha ${i}`);
                entrys.push(Math.floor(Math.random() * 100) + 50);
                outlays.push(Math.floor(Math.random() * 100) + 50);
            }

            return {
                dates: dates,
                entrys: entrys,
                outlays: outlays
            };
        }

        function getDatesBetween(startDate, endDate) {
            const dates = []
            //console.log(startDate.getDate)

            var sDate = new Date(startDate);
            var eDate = new Date(endDate);
            console.log(sDate.getDate() + 1)
            console.log(sDate.getMonth() + 1)
            console.log(sDate.getYear() + 1900)
            
            // Las fechas en JS inician en 0.
            var sDay = sDate.getDate();
            var sMonth = sDate.getMonth();
            var sYear = sDate.getYear();
            //var eDay = eDate.getDate();
            //var eMonth = eDate.getMonth();
            //var eYear = eDate.getYear();
            
            const currentDate = new Date(startDate[2], startDate[1] - 1, startDate[0]);
            const endDateObj = new Date(endDate[2], endDate[1] - 1, endDate[0]);
            console.log(currentDate[0])
            console.log(endDateObj[0])
            
            while (sDate <= eDate) {
                var sDay = sDate.getDate();
                var sMonth = sDate.getMonth() + 1;
                var sYear = sDate.getYear();
                dates.push([day, month, year]);
                sDate.setDate(sDate.getDate() + 1);
                console.log([day, month, year])
            }
            console.log(dates)
            return dates;
        }

        // Agregar un escucha al formulario para actualizar el gráfico cuando cambian las fechas
        dateRangeForm.addEventListener('change', generateChart);

        // Generar el gráfico inicial al cargar la página
        generateChart();
    </script>
{% endblock content %}