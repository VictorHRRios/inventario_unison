{% extends "base.html" %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}

{% block content %}
<div class="content-section">
    <h2 class="report-header">REPORTES <span class="highlight">PRESUPUESTO</span></h2>

    <form id="date-range-form">
        {% csrf_token %}
        {{ form.as_p }}
    </form>

    <!-- Contenedor para el gráfico -->
    <div>
        <canvas id="myChart" width="400" height="200"></canvas>
    </div>
    <div id="resultado"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Tu código de Chart.js -->
<script>
    // Obtener elementos del formulario y del gráfico
    const date_range_form = document.getElementById('date-range-form');
    const my_chart_canvas = document.getElementById('myChart');
    const my_chart_context = my_chart_canvas.getContext('2d');

    let myChart; // Variable auxiliar para actualizar el canvas

    // Función para generar el gráfico con fechas dinámicas
    function generateChart() {
        if (myChart) {
            myChart.destroy();
        }
        // Crear un nuevo canvas para evitar el error
        const new_canvas = document.createElement('canvas');
        new_canvas.id = 'myChart';
        if (my_chart_canvas.parentNode != null) {
            my_chart_canvas.parentNode.replaceChild(new_canvas, my_chart_canvas);
        }

        // Obtener el contexto del nuevo canvas
        const updated_chart_canvas = document.getElementById('myChart');
        const updated_chart_context = updated_chart_canvas.getContext('2d');

        // Obtener las fechas seleccionadas del formulario
        const start_date = document.getElementById('id_start_date').value;
        const end_date = document.getElementById('id_end_date').value;

        // Simular la obtención de datos dinámicos para las fechas
        const dynamic_date = getDatesBetween(start_date, end_date);
        const dynamic_entrys = getEntrysBetween(dynamic_date);
        const dynamic_outlays = getOutlaysBetween(dynamic_date);


        // Grafico
        myChart = new Chart(updated_chart_context, {
            type: "line",
            data: {
                labels: dynamic_date,
                datasets: [
                    {
                        label: 'Dinero ingresado en materiales',
                        backgroundColor: "rgba(0,0,255,1.0)",
                        borderColor: "rgba(0,0,255,0.5)",
                        data: dynamic_entrys
                    },
                    {
                        label: 'Dinero gastado en materiales',
                        backgroundColor: "rgba(255,0,0,1.0)",
                        borderColor: "rgba(255,0,0,0.5)",
                        data: dynamic_outlays
                    }
                ]
            },
            options: {
                // Puedes agregar opciones adicionales aquí
            }
        });
    }

    function getDatesBetween(start_date, end_date) {
        const dates = []

        var s_date = new Date(start_date);
        s_date.setDate(s_date.getDate() + 1); // La fecha siempre inicia atrasada, entonces la tengo que arreglar

        var e_date = new Date(end_date);
        e_date.setDate(e_date.getDate() + 2); // La fecha siempre inicia atrasada, entonces la tengo que arreglar

        while (s_date <= e_date) {
            var day = s_date.getDate();
            var month = s_date.getMonth() + 1;
            var year = s_date.getYear() + 1900;
            s_date.setDate(s_date.getDate() + 1);
            dates.push([day, month, year]);
        }

        console.log(dates);

        return dates;
    }

    function getEntrysBetween(dates) {
        var entrys_list = JSON.parse('{{ movements.entrys|safe|escapejs }}');
        data = []
        for (var entry of entrys_list) {
            var entry_date = (entry[0]).split("-")
            var day = parseInt(entry_date[2]);
            var month = parseInt(entry_date[1]);
            var year = parseInt(entry_date[0]);
            entry[0] = [day, month, year]
        }

        let aux;
        let sum;
        for (var date of dates) {
            aux = false;
            for (var entry of entrys_list) {
                sum = 0;
                if (JSON.stringify(date) == JSON.stringify(entry[0])) {
                    sum = sum + outlay[1];
                    aux = true;
                }
            }
            if (aux) {
                data.push(sum);
            }
            else {
                data.push(0)
            }
        }

        return data;
    }

    function getOutlaysBetween(dates) {
        var outlays_list = JSON.parse('{{ movements.outlays|safe|escapejs }}');
        data = []
        for (var outlay of outlays_list) {
            var outlay_date = (outlay[0]).split("-")
            var day = parseInt(outlay_date[2]);
            var month = parseInt(outlay_date[1]);
            var year = parseInt(outlay_date[0]);
            outlay[0] = [day, month, year]
        }

        let aux;
        let sum;
        for (var date of dates) {
            aux = false;
            sum = 0;
            for (var outlay of outlays_list) {
                if (JSON.stringify(date) == JSON.stringify(outlay[0])) {
                    sum = sum + outlay[1];
                    aux = true;
                }
            }
            if (aux) {
                data.push(sum);
            }
            else {
                data.push(0)
            }
        }
        return data;
    }

    // Agregar un escucha al formulario para actualizar el gráfico cuando cambian las fechas
    date_range_form.addEventListener('change', generateChart);

    // Generar el gráfico inicial al cargar la página
    generateChart();
</script>
{% endblock content %}